<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>El King's Interior – Receipt Generator</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; }
    .bg-gold { background-color: #D4AF37; }
    .text-gold { color: #D4AF37; }
    .bg-black { background-color: #000; }
    .text-black { color: #000; }
    .receipt th { background-color: #000; color: #fff; }
    .signature { border-top: 1px solid #000; width: 180px; height: 60px; }

    /* Canva iframe wrapper */
    .canva-embed {
      position: relative;
      width: 100px;
      height: 100px;
      box-shadow: 0 2px 8px rgba(63,69,81,0.16);
      border-radius: 8px;
      overflow: hidden;
    }
    .canva-embed iframe {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;
    }

    /* Signature Canvas */
    #issuerSignatureCanvas {
      border: 1px dashed #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      touch-action: none;
    }

    /* QR Code */
    #qrCodeImg {
      width: 100px;
      height: 100px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .canva-embed { width: 80px; height: 80px; }
      #issuerSignatureCanvas { width: 100% !important; height: 120px !important; }
      #qrCodeImg { width: 80px; height: 80px; }
    }

    @media print {
      body * { visibility: hidden; }
      #receiptPreview, #receiptPreview * { visibility: visible; }
      #receiptPreview { position: absolute; left: 0; top: 0; width: 100%; }
      .no-print { display: none !important; }
      .canva-embed { width: 80px; height: 80px; }
      .company-name { font-size: 1.5rem !important; }
      #issuerSignatureImg { max-height: 50px; }
      #qrCodeImg { width: 70px; height: 70px; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="container mx-auto px-4 py-8 max-w-4xl">

  <!-- Header -->
  <h1 class="text-3xl font-bold text-center mb-10 text-black">
    El King's Interior – Receipt Generator
  </h1>

  <!-- ==== INPUT FORM ==== -->
  <section class="bg-white rounded-xl shadow-lg p-8 mb-10 border border-gray-200 no-print">
    <h2 class="text-2xl font-semibold mb-6 flex items-center">
      <span class="w-2 h-8 bg-gold mr-3 rounded"></span> Customer & Receipt Details
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>
        <input id="customerName" type="text" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold" placeholder="e.g. Mr Derick" required>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
        <input id="customerPhone" type="text" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold" placeholder="e.g. +234 810 123 4567">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
        <input id="customerAddress" type="text" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold" placeholder="e.g. Ochacho Estate, Life Camp">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Receipt Date</label>
        <input id="receiptDate" type="date" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Receipt No. (Auto)</label>
        <input id="receiptNo" type="text" class="w-full px-4 py-2.5 border border-gray-300 rounded-md bg-gray-100" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
        <select id="paymentMethod" class="w-full px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold">
          <option>Cash</option>
          <option>Bank Transfer</option>
          <option>POS</option>
          <option>Mobile Money</option>
        </select>
      </div>
    </div>

    <h3 class="text-lg font-semibold mb-4 flex items-center">
      <span class="w-2 h-6 bg-gold mr-3 rounded"></span> Add Item
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <input id="description" type="text" placeholder="Description" class="px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold">
      <input id="quantity" type="number" min="1" placeholder="Qty" class="px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold">
      <input id="price" type="number" step="0.01" placeholder="Price (₦)" class="px-4 py-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-gold">
      <button id="addItemBtn" class="bg-black text-white px-6 py-2.5 rounded-md hover:bg-gray-800 transition font-medium">Add</button>
    </div>

    <!-- Live Items Table -->
    <div class="overflow-x-auto mb-6">
      <table class="w-full text-sm text-left">
        <thead class="receipt">
          <tr>
            <th class="px-4 py-2">NO.</th>
            <th class="px-4 py-2">ITEM</th>
            <th class="px-4 py-2 text-center">QTY</th>
            <th class="px-4 py-2 text-right">PRICE</th>
            <th class="px-4 py-2 text-right">TOTAL</th>
            <th class="px-4 py-2 text-center">ACTION</th>
          </tr>
        </thead>
        <tbody id="itemsTableBody"></tbody>
      </table>
    </div>

    <div class="text-right mb-6">
      <p class="text-lg font-bold text-black">Grand Total: <span id="grandTotal">₦ 0.00</span></p>
    </div>

    <!-- Issuer Signature Input -->
    <div class="mt-8 p-4 bg-gray-50 rounded-lg border">
      <h3 class="font-semibold text-gold mb-3">Issuer Signature (Philip Odeh Anyebe)</h3>
      <canvas id="issuerSignatureCanvas" width="300" height="100" class="w-full h-32 border border-dashed border-gray-400 rounded-lg"></canvas>
      <button id="clearIssuerSignature" class="text-xs text-red-600 mt-2">Clear Signature</button>
      <p class="text-xs text-gray-600 mt-1">Draw your signature above. It will appear under your name on the receipt.</p>
    </div>
  </section>

  <!-- ==== GENERATE BUTTON ==== -->
  <div class="text-center mb-8 no-print">
    <button id="generateBtn" class="bg-gold text-black px-10 py-4 rounded-md font-bold text-xl hover:bg-yellow-600 transition shadow-lg">
      Generate Receipt
    </button>
  </div>

  <!-- ==== RECEIPT PREVIEW ==== -->
  <section id="receiptPreview" class="hidden bg-white rounded-xl shadow-xl preview-container max-w-3xl mx-auto print-area">
    <!-- Top Header -->
    <div class="flex justify-between items-center border-b-2 border-black pb-4 mb-6">
      <div class="canva-embed">
        <iframe loading="lazy"
          src="https://www.canva.com/design/DAGwxTnRu_4/lRDyVdipflri6jNyCfg9Xw/view?embed"
          allowfullscreen allow="fullscreen"></iframe>
      </div>
      <div class="flex-1 text-center">
        <h1 class="company-name text-3xl md:text-4xl font-bold text-gold tracking-wider">
          EL KING'S INTERIOR
        </h1>
        <p class="text-sm text-gray-600 mt-1">— MODERNISING SPACE —</p>
      </div>
      <div class="w-24"></div>
    </div>

    <!-- Contact Info -->
    <div class="text-center text-xs text-gray-600 mb-6">
      <p>No. 123, FHA, Lugbe, Abuja | +234-810 148 6536</p>
    </div>

    <!-- Receipt Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm mb-6">
      <div>
        <p><strong>Receipt No:</strong> <span id="prevReceiptNo"></span></p>
        <p><strong>Date:</strong> <span id="prevDate"></span></p>
        <p><strong>Payment:</strong> <span id="prevPayment"></span></p>
      </div>
      <div>
        <p><strong>Customer:</strong> <span id="prevCustomerName"></span></p>
        <p><strong>Phone:</strong> <span id="prevCustomerPhone"></span></p>
        <p><strong>Address:</strong> <span id="prevCustomerAddress"></span></p>
      </div>
    </div>

    <!-- Items Table -->
    <table class="w-full text-sm mb-6">
      <thead>
        <tr class="receipt">
          <th class="px-4 py-2 text-left">NO.</th>
          <th class="px-4 py-2 text-left">ITEM</th>
          <th class="px-4 py-2 text-center">QTY</th>
          <th class="px-4 py-2 text-right">PRICE</th>
          <th class="px-4 py-2 text-right">TOTAL</th>
        </tr>
      </thead>
      <tbody id="prevTableBody" class="divide-y divide-gray-300"></tbody>
    </table>

    <!-- Total -->
    <div class="text-right mb-8">
      <p class="text-xl font-bold text-black">GRAND TOTAL: <span id="prevGrandTotal"></span></p>
    </div>

    <!-- QR Code -->
    <div class="flex justify-center mb-8">
      <div class="text-center">
        <p class="text-xs font-medium text-gray-600">Scan to Verify Receipt</p>
        <img id="qrCodeImg" src="" alt="Receipt QR Code" class="mt-2">
      </div>
    </div>

    <!-- Thank You -->
    <div class="text-center text-xs text-gray-600 mb-8">
      <p>Thank you for your patronage!</p>
      <p>We appreciate your trust in El King's Interior.</p>
    </div>

    <!-- Signatures -->
    <div class="flex justify-between items-end mb-8">
      <div>
        <p class="text-xs">Received by:</p>
        <div class="signature mt-1"></div>
        <p class="text-xs font-medium">Customer Signature</p>
      </div>
      <div class="text-right">
        <p class="text-xs font-medium">Issued by:</p>
        <p class="text-sm font-bold">Philip Odeh Anyebe</p>
        <img id="issuerSignatureImg" src="" alt="Philip Odeh Anyebe Signature" class="hidden max-w-full h-auto mt-1">
      </div>
    </div>

    <!-- Footer -->
    <div class="pt-4 border-t border-gray-300 text-center text-xs text-gray-500">
      <p>kingsspacedesigns.netlify.app</p>
    </div>
  </section>

  <!-- ==== ACTION BUTTONS ==== -->
  <div id="actionButtons" class="hidden flex flex-wrap justify-center gap-4 mt-8 no-print">
    <button id="printBtn" class="bg-black text-white px-8 py-3.5 rounded-md font-bold text-lg hover:bg-gray-800 transition shadow-lg">
      Print / Save as PDF
    </button>
    <button id="emailBtn" class="bg-gold text-black px-8 py-3.5 rounded-md font-bold text-lg hover:bg-yellow-600 transition shadow-lg">
      Email Receipt
    </button>
  </div>
</div>

<script>
  // Auto Receipt Number
  const getNextReceiptNo = () => {
    const year = new Date().getFullYear();
    const key = `lastReceiptNo_${year}`;
    const last = parseInt(localStorage.getItem(key) || '0');
    const next = last + 1;
    localStorage.setItem(key, next);
    return `REC-${year}-${String(next).padStart(3, '0')}`;
  };

  // Initialize
  document.getElementById('receiptDate').valueAsDate = new Date();
  document.getElementById('receiptNo').value = getNextReceiptNo();

  const items = [];
  let serialNo = 1;

  const formatCurrency = n => '₦ ' + parseFloat(n).toLocaleString('en-NG', { minimumFractionDigits: 2 });

  // === Issuer Signature Canvas ===
  const canvas = document.getElementById('issuerSignatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;

  const startDraw = (e) => {
    drawing = true;
    ctx.beginPath();
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    ctx.moveTo(x, y);
  };

  const draw = (e) => {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    ctx.lineTo(x, y);
    ctx.stroke();
  };

  const stopDraw = () => { drawing = false; };

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseout', stopDraw);
  canvas.addEventListener('touchstart', startDraw);
  canvas.addEventListener('touchmove', draw);
  canvas.addEventListener('touchend', stopDraw);

  document.getElementById('clearIssuerSignature').addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Add item
  document.getElementById('addItemBtn').addEventListener('click', () => {
    const desc = document.getElementById('description').value.trim();
    const qty  = +document.getElementById('quantity').value;
    const price = +document.getElementById('price').value;

    if (!desc || qty <= 0 || price <= 0) {
      alert('Please fill description, quantity, and price with valid values.');
      return;
    }

    items.push({ serialNo: serialNo++, desc, qty, price, total: qty * price });
    updateTable();
    clearInputs();
  });

  const clearInputs = () => {
    document.getElementById('description').value = '';
    document.getElementById('quantity').value = '';
    document.getElementById('price').value = '';
  };

  const updateTable = () => {
    const tbody = document.getElementById('itemsTableBody');
    tbody.innerHTML = '';
    let total = 0;

    items.forEach((it, i) => {
      total += it.total;
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-50';
      tr.innerHTML = `
        <td class="px-4 py-2">${it.serialNo}</td>
        <td class="px-4 py-2">${it.desc}</td>
        <td class="px-4 py-2 text-center">${it.qty}</td>
        <td class="px-4 py-2 text-right">${formatCurrency(it.price)}</td>
        <td class="px-4 py-2 text-right font-medium">${formatCurrency(it.total)}</td>
        <td class="px-4 py-2 text-center">
          <button onclick="removeItem(${i})" class="text-red-600 hover:text-red-800 text-xs">Remove</button>
        </td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(total);
  };

  window.removeItem = idx => {
    items.splice(idx, 1);
    items.forEach((it, i) => it.serialNo = i + 1);
    serialNo = items.length + 1;
    updateTable();
  };

  // Generate Receipt
  document.getElementById('generateBtn').addEventListener('click', () => {
    if (items.length === 0) return alert('Add at least one item.');
    if (!document.getElementById('customerName').value.trim()) return alert('Customer name is required.');

    // Check signature
    const hasSignature = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
    if (!hasSignature) return alert('Please sign as Philip Odeh Anyebe before generating the receipt.');

    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim() || 'N/A';
    const address = document.getElementById('customerAddress').value.trim() || 'N/A';
    const date = new Date(document.getElementById('receiptDate').value);
    const receiptNo = document.getElementById('receiptNo').value;
    const payment = document.getElementById('paymentMethod').value;

    const fmtDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
    const total = items.reduce((sum, it) => sum + it.total, 0);

    // === Generate QR Code ===
    const qrData = {
      receipt_no: receiptNo,
      date: fmtDate,
      customer: name,
      total: formatCurrency(total),
      payment_method: payment,
      issuer: "Philip Odeh Anyebe"
    };
    const qrText = JSON.stringify(qrData, null, 2);
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
    document.getElementById('qrCodeImg').src = qrUrl;

    // Fill preview
    document.getElementById('prevReceiptNo').textContent = receiptNo;
    document.getElementById('prevDate').textContent = fmtDate;
    document.getElementById('prevPayment').textContent = payment;
    document.getElementById('prevCustomerName').textContent = name;
    document.getElementById('prevCustomerPhone').textContent = phone;
    document.getElementById('prevCustomerAddress').textContent = address;

    const tbody = document.getElementById('prevTableBody');
    tbody.innerHTML = '';
    items.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-4 py-2">${it.serialNo}</td>
        <td class="px-4 py-2">${it.desc}</td>
        <td class="px-4 py-2 text-center">${it.qty}</td>
        <td class="px-4 py-2 text-right">${formatCurrency(it.price)}</td>
        <td class="px-4 py-2 text-right font-medium">${formatCurrency(it.total)}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('prevGrandTotal').textContent = formatCurrency(total);

    // Embed signature
    const sigImg = document.getElementById('issuerSignatureImg');
    sigImg.src = canvas.toDataURL();
    sigImg.classList.remove('hidden');

    // Show
    document.getElementById('receiptPreview').classList.remove('hidden');
    document.getElementById('actionButtons').classList.remove('hidden');
    document.getElementById('generateBtn').classList.add('hidden');
  });

  // Print / Save as PDF
  document.getElementById('printBtn').addEventListener('click', () => window.print());

  // Email Receipt
  document.getElementById('emailBtn').addEventListener('click', () => {
    const subject = `Receipt ${document.getElementById('prevReceiptNo').textContent} - El King's Interior`;
    const body = document.getElementById('receiptPreview').innerHTML;
    const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(
      `<html><head><style>body{font-family:Montserrat,sans-serif;}</style></head><body>${body}</body></html>`
    )}`;
    window.location.href = mailto;
  });
</script>
</body>
</html>